<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/event-dom/extra/event-valuechange.js - Itsa</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="Itsa"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Event.html">Event</a></li>
            
                <li><a href="../classes/Event.Emitter.html">Event.Emitter</a></li>
            
                <li><a href="../classes/Event.Listener.html">Event.Listener</a></li>
            
                <li><a href="../classes/Function.html">Function</a></li>
            
                <li><a href="../classes/IO.html">IO</a></li>
            
                <li><a href="../classes/ITSA.html">ITSA</a></li>
            
                <li><a href="../classes/Object.html">Object</a></li>
            
                <li><a href="../classes/Promise.html">Promise</a></li>
            
                <li><a href="../classes/Utils.html">Utils</a></li>
            
                <li><a href="../classes/window.html">window</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/event.html">event</a></li>
            
                <li><a href="../modules/event-dom.html">event-dom</a></li>
            
                <li><a href="../modules/event-emitter.html">event-emitter</a></li>
            
                <li><a href="../modules/event-hover.html">event-hover</a></li>
            
                <li><a href="../modules/event-listener.html">event-listener</a></li>
            
                <li><a href="../modules/event-mobile.html">event-mobile</a></li>
            
                <li><a href="../modules/extend-function.html">extend-function</a></li>
            
                <li><a href="../modules/extend-object.html">extend-object</a></li>
            
                <li><a href="../modules/extend-promise.html">extend-promise</a></li>
            
                <li><a href="../modules/io.html">io</a></li>
            
                <li><a href="../modules/io-assets.html">io-assets</a></li>
            
                <li><a href="../modules/io-cors.html">io-cors</a></li>
            
                <li><a href="../modules/io-jsonp.html">io-jsonp</a></li>
            
                <li><a href="../modules/io-transfer.html">io-transfer</a></li>
            
                <li><a href="../modules/io-xml.html">io-xml</a></li>
            
                <li><a href="../modules/itsa.build.html">itsa.build</a></li>
            
                <li><a href="../modules/js-ext.html">js-ext</a></li>
            
                <li><a href="../modules/node-win.html">node-win</a></li>
            
                <li><a href="../modules/utils.html">utils</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: src/event-dom/extra/event-valuechange.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&quot;use strict&quot;;

/**
 * Adds the &#x60;hover&#x60; event as a DOM-event to event-dom. more about DOM-events:
 * http://www.smashingmagazine.com/2013/11/12/an-introduction-to-dom-events/
 *
 * Should be called using  the provided &#x60;mergeInto&#x60;-method like this:
 *
 *
 * &lt;i&gt;Copyright (c) 2014 ITSA - https://github.com/itsa&lt;/i&gt;
 * New BSD License - http://choosealicense.com/licenses/bsd-3-clause/
 *
 * @example
 * Event = require(&#x27;event-dom/hover.js&#x27;)(window);
 *
 * or
 *
 * @example
 * Event = require(&#x27;event-dom&#x27;)(window);
 * require(&#x27;event-dom/event-hover.js&#x27;)(window);
 *
 * @module event
 * @submodule event-hover
 * @class Event
 * @since 0.0.2
*/
require(&#x27;dom-ext&#x27;);

var NAME = &#x27;[event-valuechange]: &#x27;,
    VALUE = &#x27;value&#x27;,
    DATA_KEY = &#x27;valueChange&#x27;,
    UTILS = require(&#x27;utils&#x27;),

    /**
    Interval (in milliseconds) at which to poll for changes to the value of an
    element with one or more &#x60;valuechange&#x60; subscribers when the user is likely
    to be interacting with it.

    @property POLL_INTERVAL
    @type Number
    @default 50
    @static
    **/
    POLL_INTERVAL = 50;

console.info(NAME, &#x27;valuechange fase A&#x27;);

module.exports = function (window) {
console.info(NAME, &#x27;valuechange fase B&#x27;);
    var Event = require(&#x27;../event-dom.js&#x27;)(window),

    subscriberBlur,
    subscriberFocus,
    subscriberKeypress,

    subscriberClick,




    editableNode = function(node) {
        var editable;
        if (node===window.document) {
            return false;
        }
        console.log(NAME, &#x27;editableNodes &#x27;+node.test(&#x27;input, textarea, select&#x27;) || ((editable=node.getAttr(&#x27;contenteditable&#x27;)) &amp;&amp; (editable!==&#x27;false&#x27;)));
        return node.test(&#x27;input, textarea, select&#x27;) || ((editable=node.getAttr(&#x27;contenteditable&#x27;)) &amp;&amp; (editable!==&#x27;false&#x27;));
    },

    startFocus = function(e) {
        console.log(NAME, &#x27;startFocus&#x27;);
        var node = e.target,
            editable, valueChangeData, previousValue;

        if (!editableNode(node)) {
            return;
        }

        // first backup the current value:
        editable = ((editable=node.getAttr(&#x27;contenteditable&#x27;)) &amp;&amp; (editable!==&#x27;false&#x27;));
        valueChangeData = node.getData(DATA_KEY);

        if (!valueChangeData) {
            valueChangeData = {
                editable : editable
            };
            node.setData(DATA_KEY, valueChangeData);
        }
        valueChangeData.prevVal = editable ? node.innerHTML : node[VALUE];

        // now activate keylistener: this must be an after-listener, because the key is then part of the value
        subscriberKeypress = Event.after(&#x27;keypress&#x27;, checkChanged);

        // now activate a mouselistener, in case of when someone right-clicks and pasts data.
        // should be after mousepress: the node has to be focussed first to start capturing
        // check all buttons: the user may have swapped functionality
        // Also, check &#x60;press&#x60; event, which is generated by HammerJS: this to support mobile:
        subscriberClick = Event.after([&#x27;click&#x27;, &#x27;press&#x27;], startPolling);

    },

    endFocus = function(e) {
        console.log(NAME, &#x27;endFocus&#x27;);
        subscriberKeypress &amp;&amp; subscriberKeypress.detach();
        subscriberClick &amp;&amp; subscriberClick.detach();
        stopPolling(e.target);
    },

    /*
     * Creates the &#x60;hover&#x60; event. The eventobject has the property &#x60;e.hover&#x60; which is a &#x60;Promise&#x60;.
     * You can use this Promise to get notification of the end of hover. The Promise e.hover gets resolved with
     * &#x60;relatedTarget&#x60; as argument: the node where the mouse went into when leaving a.target.
     *
     * @method setupValueChange
     * @private
     * @since 0.0.2
     */
    setupValueChange = function() {
        console.log(NAME, &#x27;setupValueChange&#x27;);
        // create only after subscribing to the &#x60;hover&#x60;-event
        subscriberBlur = Event.after(&#x27;blur&#x27;, endFocus);
        subscriberFocus = Event.after(&#x27;focus&#x27;, startFocus);
        startFocus({target: window.document.activeElement});
    },

    startPolling = function(e) {
        var node = e.target,
            valueChangeData;

        if (!editableNode(node)) {
            return;
        }
        console.log(NAME, &#x27;startPolling&#x27;);

        valueChangeData = node.getData(DATA_KEY);
        // cancel previous timer: we don&#x27;t want multiple timers:
        valueChangeData.timer &amp;&amp; valueChangeData.timer.cancel();
        // setup a new timer:
        valueChangeData.timer = UTILS.later(checkChanged.bind(null, e), POLL_INTERVAL, true);
    },

    stopPolling = function(node) {
        console.log(NAME, &#x27;stopPolling&#x27;);
        var valueChangeData = node.getData(DATA_KEY);
        valueChangeData &amp;&amp; valueChangeData.timer &amp;&amp; valueChangeData.timer.cancel();
    },

    checkChanged = function(e) {
        console.log(NAME, &#x27;checkChanged&#x27;);
        var node = e.target,
            prevData = node.getData(DATA_KEY),
            editable = ((editable=node.getAttr(&#x27;contenteditable&#x27;)) &amp;&amp; (editable!==&#x27;false&#x27;)),
            currentData = editable ? node.innerHTML : node[VALUE];
        if (currentData!==prevData.prevVal) {
            console.log(NAME, &#x27;checkChanged --&gt; value has been changed&#x27;);
            window.document._emitVC(node, currentData);
            prevData.prevVal = currentData;
            stopPolling(node);
        }
    },

    /*
     * Removes the &#x60;hover&#x60; event. Because there are no subscribers anymore.
     *
     * @method teardownValueChange
     * @private
     * @since 0.0.2
     */
    teardownValueChange = function() {
        // check if there aren&#x27;t any subscribers anymore.
        // in that case, we detach the &#x60;mouseover&#x60; lister because we don&#x27;t want to
        // loose performance.
        if (!Event._subs[&#x27;UI:valuechange&#x27;]) {
            console.log(NAME, &#x27;teardownValueChange: stop setting up blur and focus-event&#x27;);
            subscriberBlur.detach();
            subscriberFocus.detach();
            // also stop any possible action/listeners to a current element:
            endFocus({target: window.document.activeElement});
            // reinit notifier, because it is a one-time notifier:
            Event.notify(&#x27;UI:valuechange&#x27;, setupValueChange, Event, true);
        }
    };

    Event.notify(&#x27;UI:valuechange&#x27;, setupValueChange, Event, true);
    Event.notifyDetach(&#x27;UI:valuechange&#x27;, teardownValueChange, Event);

    // Set up document._emitVC, so that Element.setValue() will emit the &#x60;valuechange&#x60;-event:
    window.document._emitVC = function(node, value) {
        console.log(NAME, &#x27;document._emitVC&#x27;);
        var e = {
            value: value,
            target: node,
            currentTarget: window.document,
            sourceTarget: node
        };
        Event.emit(node, &#x27;UI:valuechange&#x27;, e);
    };

    return Event;
};

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
